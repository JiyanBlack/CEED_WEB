var sample = {
    "geocoded_waypoints": [
        {
            "geocoder_status": "OK",
            "place_id": "ChIJeem5LP2kMioRlWjmckPJOkw",
            "types": ["route"]
        }, {
            "geocoder_status": "OK",
            "place_id": "ChIJhdQzVPqkMioRe2DN-FjP6cA",
            "types": ["bus_station", "establishment", "point_of_interest", "transit_station"]
        }
    ],
    "routes": [
        {
            "bounds": {
                "northeast": {
                    "lat": -31.9672633,
                    "lng": 115.8167616
                },
                "southwest": {
                    "lat": -31.9737911,
                    "lng": 115.8134561
                }
            },
            "copyrights": "Map data ©2016 Google",
            "legs": [
                {
                    "arrival_time": {
                        "text": "11:57am",
                        "time_zone": "Australia/Perth",
                        "value": 1480391820
                    },
                    "departure_time": {
                        "text": "11:53am",
                        "time_zone": "Australia/Perth",
                        "value": 1480391580
                    },
                    "distance": {
                        "text": "1.0 km",
                        "value": 1023
                    },
                    "duration": {
                        "text": "4 mins",
                        "value": 240
                    },
                    "end_address": "Hampden Rd After Karella St, Nedlands WA 6009",
                    "end_location": {
                        "lat": -31.9737911,
                        "lng": 115.8135194
                    },
                    "start_address": "Hospital Ave, Nedlands WA 6009, Australia",
                    "start_location": {
                        "lat": -31.9672633,
                        "lng": 115.8167616
                    },
                    "steps": [
                        {
                            "distance": {
                                "text": "1.0 km",
                                "value": 1023
                            },
                            "duration": {
                                "text": "4 mins",
                                "value": 240
                            },
                            "end_location": {
                                "lat": -31.9737911,
                                "lng": 115.8135194
                            },
                            "html_instructions": "Bus towards Crawley",
                            "polyline": {
                                "points": "jrbbEwm{aUDNBAJEZCf@?fB?T?TF\\FZFjAPbH@?l@?dC?lB?d@?t@?L?tA?lBB?B@B@@BBB?D?@lA?p" +
                                    "@?h@?nC?zC?nC?B?D??K"
                            },
                            "start_location": {
                                "lat": -31.9672633,
                                "lng": 115.8167616
                            },
                            "transit_details": {
                                "arrival_stop": {
                                    "location": {
                                        "lat": -31.9737911,
                                        "lng": 115.8135194
                                    },
                                    "name": "Hampden Rd After Karella St"
                                },
                                "arrival_time": {
                                    "text": "11:57am",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480391820
                                },
                                "departure_stop": {
                                    "location": {
                                        "lat": -31.9672633,
                                        "lng": 115.8167616
                                    },
                                    "name": "Hospital Av Qeii Medical Centre"
                                },
                                "departure_time": {
                                    "text": "11:53am",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480391580
                                },
                                "headsign": "Crawley",
                                "line": {
                                    "agencies": [
                                        {
                                            "name": "Transperth",
                                            "url": "http://www.transperth.wa.gov.au/"
                                        }
                                    ],
                                    "color": "#002f6c",
                                    "short_name": "97",
                                    "text_color": "#ffffff",
                                    "url": "http://www.transperth.wa.gov.au/timetables/details?Bus=97",
                                    "vehicle": {
                                        "icon": "//maps.gstatic.com/mapfiles/transit/iw2/6/bus2.png",
                                        "name": "Bus",
                                        "type": "BUS"
                                    }
                                },
                                "num_stops": 3
                            },
                            "travel_mode": "TRANSIT"
                        }
                    ],
                    "traffic_speed_entry": [],
                    "via_waypoint": []
                }
            ],
            "overview_polyline": {
                "points": "jrbbEwm{aUDNNGbAC|B?zCh@bH@?l@?rF?zA?bB?lBB?FBDF?F~B?tI?rC?D??K"
            },
            "summary": "",
            "warnings": [],
            "waypoint_order": []
        }, {
            "bounds": {
                "northeast": {
                    "lat": -31.9672633,
                    "lng": 115.8167616
                },
                "southwest": {
                    "lat": -31.9737911,
                    "lng": 115.8134561
                }
            },
            "copyrights": "Map data ©2016 Google",
            "legs": [
                {
                    "arrival_time": {
                        "text": "11:58am",
                        "time_zone": "Australia/Perth",
                        "value": 1480391880
                    },
                    "departure_time": {
                        "text": "11:55am",
                        "time_zone": "Australia/Perth",
                        "value": 1480391700
                    },
                    "distance": {
                        "text": "1.0 km",
                        "value": 1023
                    },
                    "duration": {
                        "text": "3 mins",
                        "value": 180
                    },
                    "end_address": "Hampden Rd After Karella St, Nedlands WA 6009",
                    "end_location": {
                        "lat": -31.9737911,
                        "lng": 115.8135194
                    },
                    "start_address": "Hospital Ave, Nedlands WA 6009, Australia",
                    "start_location": {
                        "lat": -31.9672633,
                        "lng": 115.8167616
                    },
                    "steps": [
                        {
                            "distance": {
                                "text": "1.0 km",
                                "value": 1023
                            },
                            "duration": {
                                "text": "3 mins",
                                "value": 180
                            },
                            "end_location": {
                                "lat": -31.9737911,
                                "lng": 115.8135194
                            },
                            "html_instructions": "Bus towards Fremantle Stn",
                            "polyline": {
                                "points": "jrbbEwm{aUDNBAJEZCf@?fB?T?TF\\FZFjAPbH@?l@?dC?lB?d@?t@?L?tA?lBB?B@B@@BBB?D?@lA?p" +
                                    "@?h@?nC?zC?nC?B?D??K"
                            },
                            "start_location": {
                                "lat": -31.9672633,
                                "lng": 115.8167616
                            },
                            "transit_details": {
                                "arrival_stop": {
                                    "location": {
                                        "lat": -31.9737911,
                                        "lng": 115.8135194
                                    },
                                    "name": "Hampden Rd After Karella St"
                                },
                                "arrival_time": {
                                    "text": "11:58am",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480391880
                                },
                                "departure_stop": {
                                    "location": {
                                        "lat": -31.9672633,
                                        "lng": 115.8167616
                                    },
                                    "name": "Hospital Av Qeii Medical Centre"
                                },
                                "departure_time": {
                                    "text": "11:55am",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480391700
                                },
                                "headsign": "Fremantle Stn",
                                "line": {
                                    "agencies": [
                                        {
                                            "name": "Transperth",
                                            "url": "http://www.transperth.wa.gov.au/"
                                        }
                                    ],
                                    "color": "#002f6c",
                                    "short_name": "103",
                                    "text_color": "#ffffff",
                                    "url": "http://www.transperth.wa.gov.au/timetables/details?Bus=103",
                                    "vehicle": {
                                        "icon": "//maps.gstatic.com/mapfiles/transit/iw2/6/bus2.png",
                                        "name": "Bus",
                                        "type": "BUS"
                                    }
                                },
                                "num_stops": 3
                            },
                            "travel_mode": "TRANSIT"
                        }
                    ],
                    "traffic_speed_entry": [],
                    "via_waypoint": []
                }
            ],
            "overview_polyline": {
                "points": "jrbbEwm{aUDNNGbAC|B?zCh@bH@?l@?rF?zA?bB?lBB?FBDF?F~B?tI?rC?D??K"
            },
            "summary": "",
            "warnings": [],
            "waypoint_order": []
        }, {
            "bounds": {
                "northeast": {
                    "lat": -31.9672633,
                    "lng": 115.8167616
                },
                "southwest": {
                    "lat": -31.9737911,
                    "lng": 115.8134561
                }
            },
            "copyrights": "Map data ©2016 Google",
            "legs": [
                {
                    "arrival_time": {
                        "text": "11:59am",
                        "time_zone": "Australia/Perth",
                        "value": 1480391940
                    },
                    "departure_time": {
                        "text": "11:56am",
                        "time_zone": "Australia/Perth",
                        "value": 1480391760
                    },
                    "distance": {
                        "text": "1.0 km",
                        "value": 1023
                    },
                    "duration": {
                        "text": "3 mins",
                        "value": 180
                    },
                    "end_address": "Hampden Rd After Karella St, Nedlands WA 6009",
                    "end_location": {
                        "lat": -31.9737911,
                        "lng": 115.8135194
                    },
                    "start_address": "Hospital Ave, Nedlands WA 6009, Australia",
                    "start_location": {
                        "lat": -31.9672633,
                        "lng": 115.8167616
                    },
                    "steps": [
                        {
                            "distance": {
                                "text": "1.0 km",
                                "value": 1023
                            },
                            "duration": {
                                "text": "3 mins",
                                "value": 180
                            },
                            "end_location": {
                                "lat": -31.9737911,
                                "lng": 115.8135194
                            },
                            "html_instructions": "Bus towards Morley Bus Stn",
                            "polyline": {
                                "points": "jrbbEwm{aUDNBAJEZCf@?fB?T?TF\\FZFjAPbH@?l@?dC?lB?d@?t@?L?tA?lBB?B@B@@BBB?D?@lA?p" +
                                    "@?h@?nC?zC?nC?B?D??K"
                            },
                            "start_location": {
                                "lat": -31.9672633,
                                "lng": 115.8167616
                            },
                            "transit_details": {
                                "arrival_stop": {
                                    "location": {
                                        "lat": -31.9737911,
                                        "lng": 115.8135194
                                    },
                                    "name": "Hampden Rd After Karella St"
                                },
                                "arrival_time": {
                                    "text": "11:59am",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480391940
                                },
                                "departure_stop": {
                                    "location": {
                                        "lat": -31.9672633,
                                        "lng": 115.8167616
                                    },
                                    "name": "Hospital Av Qeii Medical Centre"
                                },
                                "departure_time": {
                                    "text": "11:56am",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480391760
                                },
                                "headsign": "Morley Bus Stn",
                                "line": {
                                    "agencies": [
                                        {
                                            "name": "Transperth",
                                            "url": "http://www.transperth.wa.gov.au/"
                                        }
                                    ],
                                    "color": "#009639",
                                    "short_name": "950",
                                    "text_color": "#ffffff",
                                    "url": "http://www.transperth.wa.gov.au/timetables/details?Bus=950",
                                    "vehicle": {
                                        "icon": "//maps.gstatic.com/mapfiles/transit/iw2/6/bus2.png",
                                        "name": "Bus",
                                        "type": "BUS"
                                    }
                                },
                                "num_stops": 3
                            },
                            "travel_mode": "TRANSIT"
                        }
                    ],
                    "traffic_speed_entry": [],
                    "via_waypoint": []
                }
            ],
            "overview_polyline": {
                "points": "jrbbEwm{aUDNBAJEZCnC?T?TFx@NjAPbH@?rD?rC?xC?lBB?FBDNhD?~L?D??K"
            },
            "summary": "",
            "warnings": [],
            "waypoint_order": []
        }, {
            "bounds": {
                "northeast": {
                    "lat": -31.9672633,
                    "lng": 115.8167616
                },
                "southwest": {
                    "lat": -31.9737911,
                    "lng": 115.8134561
                }
            },
            "copyrights": "Map data ©2016 Google",
            "legs": [
                {
                    "arrival_time": {
                        "text": "12:06pm",
                        "time_zone": "Australia/Perth",
                        "value": 1480392360
                    },
                    "departure_time": {
                        "text": "12:03pm",
                        "time_zone": "Australia/Perth",
                        "value": 1480392180
                    },
                    "distance": {
                        "text": "1.0 km",
                        "value": 1023
                    },
                    "duration": {
                        "text": "3 mins",
                        "value": 180
                    },
                    "end_address": "Hampden Rd After Karella St, Nedlands WA 6009",
                    "end_location": {
                        "lat": -31.9737911,
                        "lng": 115.8135194
                    },
                    "start_address": "Hospital Ave, Nedlands WA 6009, Australia",
                    "start_location": {
                        "lat": -31.9672633,
                        "lng": 115.8167616
                    },
                    "steps": [
                        {
                            "distance": {
                                "text": "1.0 km",
                                "value": 1023
                            },
                            "duration": {
                                "text": "3 mins",
                                "value": 180
                            },
                            "end_location": {
                                "lat": -31.9737911,
                                "lng": 115.8135194
                            },
                            "html_instructions": "Bus towards Morley Bus Stn",
                            "polyline": {
                                "points": "jrbbEwm{aUDNBAJEZCf@?fB?T?TF\\FZFjAPbH@?l@?dC?lB?d@?t@?L?tA?lBB?B@B@@BBB?D?@lA?p" +
                                    "@?h@?nC?zC?nC?B?D??K"
                            },
                            "start_location": {
                                "lat": -31.9672633,
                                "lng": 115.8167616
                            },
                            "transit_details": {
                                "arrival_stop": {
                                    "location": {
                                        "lat": -31.9737911,
                                        "lng": 115.8135194
                                    },
                                    "name": "Hampden Rd After Karella St"
                                },
                                "arrival_time": {
                                    "text": "12:06pm",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480392360
                                },
                                "departure_stop": {
                                    "location": {
                                        "lat": -31.9672633,
                                        "lng": 115.8167616
                                    },
                                    "name": "Hospital Av Qeii Medical Centre"
                                },
                                "departure_time": {
                                    "text": "12:03pm",
                                    "time_zone": "Australia/Perth",
                                    "value": 1480392180
                                },
                                "headsign": "Morley Bus Stn",
                                "line": {
                                    "agencies": [
                                        {
                                            "name": "Transperth",
                                            "url": "http://www.transperth.wa.gov.au/"
                                        }
                                    ],
                                    "color": "#009639",
                                    "short_name": "950",
                                    "text_color": "#ffffff",
                                    "url": "http://www.transperth.wa.gov.au/timetables/details?Bus=950",
                                    "vehicle": {
                                        "icon": "//maps.gstatic.com/mapfiles/transit/iw2/6/bus2.png",
                                        "name": "Bus",
                                        "type": "BUS"
                                    }
                                },
                                "num_stops": 3
                            },
                            "travel_mode": "TRANSIT"
                        }
                    ],
                    "traffic_speed_entry": [],
                    "via_waypoint": []
                }
            ],
            "overview_polyline": {
                "points": "jrbbEwm{aUDNBAJEZCnC?T?TFx@NjAPbH@?rD?rC?xC?lBB?FBDNhD?~L?D??K"
            },
            "summary": "",
            "warnings": [],
            "waypoint_order": []
        }
    ],
    "status": "OK"
}

var mydom = {
    'from-date': document.getElementById('from-date'),
    'to-date': document.getElementById('to-date'),
    'submit': document.getElementById('submit'),
    'reset': document.getElementById('reset'),
    'card-id': document.getElementById('card-id')
}

function startRun() {
    //initialize values...
    function setDateDefault() {
        mydom['from-date'].valueAsDate = new Date(2009, 2, 1);
        mydom['to-date'].valueAsDate = new Date(2009, 2, 1);
    }
    mydom['submit']
        .addEventListener('click', function (event) {
            event.preventDefault();
            cardId = mydom['card-id'].value;
            ajax_get('user/' + cardId, function (xhttp) {
                console.log(xhttp.responseText);
            });
        });
    mydom['reset'].addEventListener('click', function (event) {
        event.preventDefault();
        setDateDefault();
        mydom['card-id'].value = "";
    });
    setDateDefault();
}

function ajax_get(url, callback) {
    var xhttp;
    xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            callback(this);
        }
    };
    xhttp.open("GET", url, true);
    xhttp.send();
}

function initMap() {
    // Create a map object and specify the DOM element for display.
    function randomPickColor() {
        var hexColor = [
            "#ffc0cb",
            "#900090",
            "#051152",
            "#ad5a7a",
            "#f9c780",
            "#5a7aad",
            "#403f51",
            "#e3780a",
            "#00ad06",
            "#461499",
            "#418a14",
            "#794044",
            "#c8ebd0"
        ];
        return hexColor[Math.floor(Math.random() * hexColor.length)];
    }
    var map_option = {
        center: {
            lat: -31.986,
            lng: 115.971
        },
        scrollwheel: true,
        zoom: 11,
        mapTypeId: 'roadmap'
    }
    var map = new google
        .maps
        .Map(document.getElementById('map'), map_option);

    //
    function drawLineByEncoded(encoded, color) {
        var decodedPath = google
            .maps
            .geometry
            .encoding
            .decodePath(encoded)
        var apolyline = new google
            .maps
            .Polyline({path: decodedPath, geodesic: true, strokeColor: color, strokeOpacity: 1.0, strokeWeight: 3});
        apolyline.setMap(map);
    }

    // add marker to map
    function addMarker(content, label, lat, lon) {
        var myLatlng = new google
            .maps
            .LatLng(lat, lon);
        var infowindow = new google
            .maps
            .InfoWindow({content: content});
        var marker = new google
            .maps
            .Marker({position: myLatlng, label: label});
        marker.setMap(map);
        marker.addListener('click', function () {
            infowindow.open(map, marker);
        });

    }

    drawLineByEncoded("jrbbEwm{aUDNBAJEZCnC?T?TFx@NjAPbH@?rD?rC?xC?lBB?FBDNhD?~L?D??K", randomPickColor());
    addMarker('97|233|182', '1S', -31.9672633, 115.8167616);
    renderSingleJson(sample, 1);

    function renderSingleJson(ajson, counter) {
        var routes = ajson.routes;
        var min_legs;
        var origin_start;
        var origin_end;
        var start_label;
        var end_label;
        var start_latlon;
        var end_latlon;
        //delete routes with two transit in legs
        for (var i = 0; i < routes.length; i++) {
            var cur_route = routes[i];
            var cur_legs = cur_route.legs;
            var transit_number = 0;
            var final_leg;
            var final_steps;
            for (var j = 0; j < cur_legs.length; j++) {
                var cur_steps = cur_legs[j].steps;
                for (var m = 0; m < cur_steps.length; m++) {
                    if (cur_steps[m]["travel_mode"] == "TRANSIT") {
                        transit_number += 1;
                        final_legs = cur_legs[j];
                        final_steps = cur_steps[m];
                    }
                }
            }
            if (transit_number == 1) {
                final_legs.steps = final_steps;
                routes[i].legs = final_legs;
            } else {
                routes[i] = undefined;
            }
        }
        console.log(JSON.stringify(routes, null, 2));
        // find out correct routes,filter out routes with legs that are not same with
        // the first one
        for (var i = 0; i < routes.length; i++) {
            cur_route = routes[i];
            if (i == 0) {
                start_address = cur_route.legs.['start_address'];
                end_address = cur_route.legs.['end_address'];
                start_latlon = cur_route.legs.['start_location'];
                end_latlon = cur_route.legs.['end_location'];
            } else {
                if (cur_route.legs['start_address'] == start_address && cur_route.legs.['end_address'] == end_address) {}
            }
        }
    }
}

startRun();